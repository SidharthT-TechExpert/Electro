<!-- Bootstrap & FontAwesome -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
<link rel="stylesheet" href="/css/admin/DashBoard/header.css">
<link rel="stylesheet" href="/css/admin/DashBoard/customerList.css">
<link rel="stylesheet" href="/css/admin/DashBoard/category.css">
<link rel="stylesheet" href="/css/admin/DashBoard/ProductDetails.css">
<link rel="stylesheet" href="/css/admin/DashBoard/pageNavigation.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<style>
  .image-upload-placeholder {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px dashed #6c757d;
    padding: 10px;
    width: 100px;
    height: 50px;
  }

  .image-upload-placeholder i {
    margin-right: 5px;
  }
</style>

<%- include("../../partials/admin/sidebar") %>
  <%- include("../../partials/admin/header") %>
    <%- include("../../partials/user/messages") %>

      <div class="main-content">

        <!-- Page Header -->
        <div class="content-header">
          <h2>Banners</h2>
          <div class="page-header mb-3">
            <a onclick="addBannerModal()" class="btn btn-primary"><i class="fa fa-plus"></i> Add Banner</a>
          </div>
        </div>

        <!-- Banners Table -->
        <div class="table-wrapper table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Banner Title</th>
                <th>Image</th>
                <th>Button Link</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% bannerData.forEach((banner, i)=> { %>
                <tr>
                  <td>
                    <%= i + 1 %>
                  </td>
                  <td class="banner-title">
                    <%= banner.title %>
                  </td>
                  <td class="banner-image">
                    <img src="<%= banner.image %>" alt="<%= banner.title %>" style="width:100px; height:auto;">
                  </td>
                  <td class="banner-link">
                    <%= banner.buttonLink || '-' %>
                  </td>
                  <td class="banner-start">
                    <%= new Date(banner.startDate).toLocaleDateString() %>
                  </td>
                  <td class="banner-end">
                    <%= new Date(banner.endDate).toLocaleDateString() %>
                  </td>
                  <td class="status-badge-<%= banner._id %>">
                    <% const today=new Date(); const startDate=new Date(banner.startDate); const endDate=new
                      Date(banner.endDate); %>
                      <% if (today < startDate && banner.isActive) { %>
                        <span class="badge bg-secondary">Upcoming</span>
                        <% } else if (today> endDate || !banner.isActive) { %>
                          <span class="badge bg-danger">Expired</span>
                          <% } else { %>
                            <span class="badge bg-success">Active</span>
                            <% } %>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-warning me-1" onclick="editBanner('<%= banner._id %>')">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteBanner('<%= banner._id %>')">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                <% }) %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination mt-3">
          <% if (currentPage> 1) { %>
            <a href="?page=<%= currentPage - 1 %>"><button class="nav-btn">Prev</button></a>
            <% } else { %>
              <button class="nav-btn" disabled>Prev</button>
              <% } %>

                <% for (let i=1; i <=totalPages; i++) { %>
                  <% if (currentPage===i) { %>
                    <button class="page-btn active">
                      <%= i %>
                    </button>
                    <% } else { %>
                      <a href="?page=<%= i %>"><button class="page-btn">
                          <%= i %>
                        </button></a>
                      <% } %>
                        <% } %>

                          <% if (currentPage < totalPages) { %>
                            <a href="?page=<%= currentPage + 1 %>"><button class="nav-btn">Next</button></a>
                            <% } else { %>
                              <button class="nav-btn" disabled>Next</button>
                              <% } %>
        </div>

      </div>

      <script>
        // ==================== Add Banner ====================
        function addBannerModal() {
          Swal.fire({
            title: "➕ Add New Banner",
            width: '600px',
            html: `
      <div class="swal-scrollable p-2">
        <div class="mb-3 text-start">
          <label class="form-label fw-bold">Title</label>
          <input type="text" id="swal-input-title" class="form-control" placeholder="Enter banner title">
        </div>
        <div class="mb-3 text-start">
          <label class="form-label fw-bold">Banner Image</label>
          <div id="swal-image-container" class="image-upload-placeholder">
            <i class="fa fa-plus"></i> <span>Add</span>
            <input type="file" id="swal-input-image" style="display:none" accept="image/*">
          </div>
          <img id="swal-image-preview" style="width:100px; margin-top:5px; display:none;">
        </div>
        <div class="mb-3 text-start">
          <label class="form-label fw-bold">Button Link</label>
          <input type="text" id="swal-input-link" class="form-control" placeholder="Enter button link">
        </div>
        <div class="mb-3 text-start">
          <label class="form-label fw-bold">Start Date</label>
          <input type="date" id="swal-input-start" class="form-control">
        </div>
        <div class="mb-3 text-start">
          <label class="form-label fw-bold">End Date</label>
          <input type="date" id="swal-input-end" class="form-control">
        </div>
        <div class="mb-3 text-start">
          <label class="form-label fw-bold">Status</label>
          <select id="swal-input-status" class="form-control">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>
    `,
            showCancelButton: true,
            confirmButtonText: "Add Banner",
            didOpen: () => {
              const container = document.getElementById("swal-image-container");
              const fileInput = document.getElementById("swal-input-image");
              const preview = document.getElementById("swal-image-preview");

              container.addEventListener("click", () => fileInput.click());
              fileInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = event => {
                    preview.src = event.target.result;
                    preview.style.display = "block";
                  };
                  reader.readAsDataURL(file);
                }
              });
            },
            preConfirm: () => {
              const title = document.getElementById("swal-input-title").value.trim();
              const fileInput = document.getElementById("swal-input-image");
              const file = fileInput.files[0];
              const buttonLink = document.getElementById("swal-input-link").value.trim();
              const startDate = document.getElementById("swal-input-start").value;
              const endDate = document.getElementById("swal-input-end").value;
              const isActive = document.getElementById("swal-input-status").value;

              if (!title || !file || !startDate || !endDate) {
                Swal.showValidationMessage("⚠️ Title, Image, Start Date, and End Date are required!");
                return false;
              }

              // Return a plain object; we will create FormData in ajax
              return { title, file, buttonLink, startDate, endDate, isActive };
            }
          }).then(result => {
            if (result.isConfirmed) {
              const formData = new FormData();
              formData.append("title", result.value.title);
              formData.append("image", result.value.file); // file must be appended here
              formData.append("buttonLink", result.value.buttonLink);
              formData.append("startDate", result.value.startDate);
              formData.append("endDate", result.value.endDate);
              formData.append("isActive", result.value.isActive);

              $.ajax({
                type: "POST",
                url: "/admin/banner",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                  if (response.success) {
                    Swal.fire({ icon: "success", title: "Banner Added Successfully", timer: 1500, showConfirmButton: false })
                      .then(() => location.reload());
                  } else {
                    Swal.fire("Error", response.message, "error");
                  }
                }
              });
            }
          });
        }


        // ==================== Edit Banner ====================
        function editBanner(id) {
          const banner = <%- JSON.stringify(bannerData) %>.find(b => b._id === id);
          if (!banner) return Swal.fire("Error", "Banner not found", "error");

          Swal.fire({
            title: "✏️ Edit Banner",
            width: '600px',
            html: `
        <div class="swal-scrollable p-2">
          <div class="mb-3 text-start">
            <label class="form-label fw-bold">Title</label>
            <input type="text" id="swal-input-title" class="form-control" value="${banner.title}">
          </div>
          <div class="mb-3 text-start">
            <label class="form-label fw-bold">Banner Image</label>
            <div id="swal-image-container" class="image-upload-placeholder">
              <i class="fa fa-plus"></i> <span>Add</span>
              <input type="file" id="swal-input-image" style="display:none" accept="image/*">
            </div>
            <img id="swal-image-preview" style="width:100px; margin-top:5px;" src="${banner.image}">
          </div>
          <div class="mb-3 text-start">
            <label class="form-label fw-bold">Button Link</label>
            <input type="text" id="swal-input-link" class="form-control" value="${banner.buttonLink || ''}">
          </div>
          <div class="mb-3 text-start">
            <label class="form-label fw-bold">Start Date</label>
            <input type="date" id="swal-input-start" class="form-control" value="${new Date(banner.startDate).toISOString().split('T')[0]}">
          </div>
          <div class="mb-3 text-start">
            <label class="form-label fw-bold">End Date</label>
            <input type="date" id="swal-input-end" class="form-control" value="${new Date(banner.endDate).toISOString().split('T')[0]}">
          </div>
          <div class="mb-3 text-start">
            <label class="form-label fw-bold">Status</label>
            <select id="swal-input-status" class="form-control">
              <option value="true" ${banner.isActive ? "selected" : ""}>Active</option>
              <option value="false" ${!banner.isActive ? "selected" : ""}>Inactive</option>
            </select>
          </div>
        </div>
      `,
            showCancelButton: true,
            confirmButtonText: "Save Changes",
            didOpen: () => {
              const container = document.getElementById("swal-image-container");
              const fileInput = document.getElementById("swal-input-image");
              const preview = document.getElementById("swal-image-preview");

              container.addEventListener("click", () => fileInput.click());
              fileInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = event => {
                    preview.src = event.target.result;
                  };
                  reader.readAsDataURL(file);
                }
              });
            },
            preConfirm: () => {
              const title = document.getElementById("swal-input-title").value.trim();
              const fileInput = document.getElementById("swal-input-image");
              const file = fileInput.files[0];
              const buttonLink = document.getElementById("swal-input-link").value.trim();
              const startDate = document.getElementById("swal-input-start").value;
              const endDate = document.getElementById("swal-input-end").value;
              const isActive = document.getElementById("swal-input-status").value === "true";

              if (!title || (!file && !banner.image) || !startDate || !endDate) {
                Swal.showValidationMessage("⚠️ Title, Image, Start Date, and End Date are required!");
                return false;
              }


              return { id, title, file, buttonLink, startDate, endDate, isActive };
            }
          }).then(result => {
            if (result.isConfirmed) {
              const formData = new FormData();
              formData.append("id", result.value.id);
              formData.append("title", result.value.title);
              if (result.value.file) formData.append("image", result.value.file); // only append if new file selected
              formData.append("buttonLink", result.value.buttonLink);
              formData.append("startDate", result.value.startDate);
              formData.append("endDate", result.value.endDate);
              formData.append("isActive", result.value.isActive);

              $.ajax({
                type: "PATCH",
                url: "/admin/banner",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                  if (response.success) {
                    Swal.fire({
                      icon: "success",
                      title: "Banner Updated Successfully",
                      timer: 1500,
                      showConfirmButton: false
                    })
                      .then(() => location.reload());
                  } else {
                    Swal.fire("Error", response.message, "error");
                  }
                }
              });
            }
          });
        }

        // ==================== Delete Banner ====================
        function deleteBanner(id) {
          Swal.fire({
            title: "Are you sure?",
            text: "This action will delete the banner permanently.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete it!",
            cancelButtonText: "Cancel"
          }).then(result => {
            if (result.isConfirmed) {
              $.ajax({
                type: "DELETE",
                url: "/admin/banners",
                data: { id },
                success: function (response) {
                  if (response.success) {
                    Swal.fire({ icon: "success", title: "Banner Deleted Successfully", timer: 1500, showConfirmButton: false })
                      .then(() => location.reload());
                  } else {
                    Swal.fire("Error", response.message, "error");
                  }
                }
              });
            }
          });
        }
      </script>