<!-- Bootstrap & FontAwesome -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<link rel="stylesheet" href="/css/admin/DashBoard/header.css">
<link rel="stylesheet" href="/css/admin/DashBoard/customerList.css">
<link rel="stylesheet" href="/css/admin/DashBoard/category.css">

<%- include("../../partials/admin/sidebar") %>
  <%- include("../../partials/admin/header") %>
    <%- include("../../partials/user/messages") %>

      <div class="main-content">

        <div class="content-header">
          <h2>Categories</h2>

          <div class="search-actions">
            <form action="/admin/categories" method="get" class="search-form">
              <!-- Search -->
              <div class="search-bar">
                <input autocomplete="none" type="text" name="search" placeholder="Search Categories..."
                  value="<%= search || '' %>" id="searchInput">
                <button type="submit"><i class="fas fa-search"></i></button>
              </div>

              <!-- Filter -->
              <select name="status" id="statusFilter" class="filter-select" onchange="this.form.submit()">
                <option value="all" <%=status==='all' ? 'selected' : '' %>>All</option>
                <option value="listed" <%=status==='listed' ? 'selected' : '' %>>Listed</option>
                <option value="unlisted" <%=status==='unlisted' ? 'selected' : '' %>>Unlisted</option>
              </select>


              <!-- Refresh -->
              <button type="button" class="btn-icon" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i>
              </button>

            </form>
          </div>
        </div>
        <div class="page-header mb-3">
          <a onclick="addCategoryModal()" class="btn btn-primary">+ Add Category</a>
        </div>

        <div class="table-wrapper">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Category Name</th>
                <th>Category Description</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% categories.forEach((cat, i)=> { %>
                <tr>
                  <td>
                    <%= i + 1 %>
                  </td>
                  <td>
                    <%= cat.name %>
                  </td>
                  <td>
                    <%= cat.description %>
                  </td>

                  <td class="status-badge-<%= cat._id %>">
                    <% if ((cat.status || "" ).toLowerCase().trim()==="listed" ) { %>
                      <span class="badge bg-success">Listed</span>
                      <% } else { %>
                        <span class="badge bg-danger">Unlisted</span>
                        <% } %>
                  </td>

                  <td class="d-flex gap-2">
                    <a style="text-decoration: none;" href="javascript:void(0);" class="btn-action btn-view toggle-btn"
                      data-id="<%= cat._id %>" data-status="<%= cat.status %>" data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="<%= (cat.status || '').toLowerCase()==='listed' ? 'Unlist Category' : 'List Category' %>">

                      <% if ((cat.status || "" ).toLowerCase().trim()==="unlisted" ) { %>
                        <i class="fa fa-eye"></i>
                        <% } else { %>
                          <i class="fa fa-eye-slash"></i>
                          <% } %>
                    </a>

                    <a style="text-decoration: none;" class="btn-action btn-edit" data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      onclick="editCategory('<%= cat._id %>', '<%= cat.name %>', '<%= cat.description %>')"
                      title="Edit Category">
                      <i class="fa fa-edit"></i>
                    </a>

                    <a style="text-decoration: none;" class="btn-action btn-delete" data-bs-toggle="tooltip"
                      data-bs-placement="top" onclick="deleteCategory('<%= cat._id %>')" title="Delete Category">
                      <i class="fa fa-trash"></i>
                    </a>
                  </td>

                </tr>
                <% }) %>
            </tbody>

          </table>
        </div>

        <%- include("../../partials/admin/pageNavigation") %>
      </div>


      <script>
        document.addEventListener("DOMContentLoaded", function () {
          document.querySelectorAll(".toggle-btn").forEach((btn) => {
            btn.addEventListener("click", function () {
              const id = this.dataset.id;
              const currentStatus = this.dataset.status;
              const isListed = (currentStatus || "").toLowerCase() === "listed";
              const newStatus = isListed ? "unlisted" : "listed";

              Swal.fire({
                icon: "warning",
                title: "Are you sure?",
                text: isListed
                  ? "This will unlist the category. It will no longer be visible to users."
                  : "This will list the category. It will be visible to users.",
                showCancelButton: true,
                confirmButtonText: isListed ? "Yes, Unlist!" : "Yes, List!",
                cancelButtonText: "Cancel",
              }).then((result) => {
                if (result.isConfirmed) {
                  $.ajax({
                    type: "PATCH",
                    url: `/admin/categories/toggle-status/${id}`,
                    data: { status: newStatus },
                    success: function (response) {
                      if (response.success) {
                        Swal.fire({
                          icon: "success",
                          title: response.message,
                          showConfirmButton: false,
                          timer: 1500,
                        });

                        // ✅ Update badge
                        const badgeCell = document.querySelector(`.status-badge-${id}`);
                        badgeCell.innerHTML =
                          response.status.toLowerCase() === "listed"
                            ? '<span class="badge bg-success">Listed</span>'
                            : '<span class="badge bg-danger">Unlisted</span>';

                        // ✅ Update button
                        btn.dataset.status = response.status; // <--- UPDATE so next click works
                        btn.setAttribute(
                          "title",
                          response.status.toLowerCase() === "listed"
                            ? "Unlist Category"
                            : "List Category"
                        );
                        btn.innerHTML =
                          response.status.toLowerCase() === "listed"
                            ? '<i class="fa fa-eye-slash"></i>'
                            : '<i class="fa fa-eye"></i>';
                      } else {
                        Swal.fire({
                          icon: "error",
                          title: "Error",
                          text: response.message,
                        });
                      }
                    },
                    error: function () {
                      Swal.fire({
                        icon: "error",
                        title: "Server Error",
                        text: "Please try again!",
                      });
                    },
                  });
                }
              });
            });
          });
        });

        function addCategoryModal() {
          Swal.fire({
            title: "➕ Add New Category",
            html: `
      <div class="mb-3 text-start">
        <label for="swal-input-title" class="form-label fw-bold">Title</label>
        <input type="text" id="swal-input-title" class="form-control" placeholder="Enter category title">
      </div>
      <div class="mb-3 text-start">
        <label for="swal-input-description" class="form-label fw-bold">Description</label>
        <textarea id="swal-input-description" class="form-control" placeholder="Enter category description" rows="3"></textarea>
      </div>
    `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: "Add Category",
            cancelButtonText: "Cancel",
            customClass: {
              popup: "swal-wide",
              confirmButton: "btn btn-primary",
              cancelButton: "btn btn-secondary me-2"
            },
            buttonsStyling: false,
            preConfirm: () => {
              const title = document.getElementById("swal-input-title").value.trim();
              const description = document.getElementById("swal-input-description").value.trim();

              if (!title) {
                Swal.showValidationMessage("⚠️ Title is required!");
                return false;
              }

              return { title, description };
            }
          }).then((result) => {
            if (result.isConfirmed) {
              const { title, description } = result.value;

              // ✅ Call backend with AJAX
              $.ajax({
                type: "POST",
                url: "/admin/categories",
                data: { name: title, description },
                success: function (response) {
                  if (response.success) {
                    Swal.fire({
                      icon: "success",
                      title: "Category Added!",
                      text: response.message,
                      timer: 1500,
                      showConfirmButton: false,
                    }).then(() => location.reload()); // reload to show updated list
                  } else {
                    Swal.fire("Error", response.message, "error");
                  }
                },
                error: function () {
                  Swal.fire({
                    icon: "error",
                    title: "Server Error",
                    text: "Please try again later!",
                  });
                },
              });
            }
          });
        }

        function deleteCategory(id) {
          Swal.fire({
            title: "Are you sure?",
            text: "This will permanently delete the category.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Yes, delete it!"
          }).then((result) => {
            if (result.isConfirmed) {
              $.ajax({
                type: "DELETE",
                url: `/admin/categories/${id}`,
                success: function (response) {
                  if (response.success) {
                    Swal.fire({
                      icon: "success",
                      title: response.message,
                      showConfirmButton: false,
                      timer: 1500
                    });
                    // ✅ remove row from table instantly
                    document.querySelector(`a[onclick="deleteCategory('${id}')"]`)
                      .closest("tr")
                      .remove();
                  } else {
                    Swal.fire("Error", response.message, "error");
                  }
                },
                error: function () {
                  Swal.fire({
                    icon: "error",
                    title: "Server Error",
                    text: "Please try again later!",
                  });
                },
              });
            }
          });
        }

        function editCategory(id, name, description) {
          Swal.fire({
            title: `<h2 style="font-weight:700; font-size:22px; color:#1e293b; display:flex; align-items:center; gap:8px;">
              <i class="fas fa-edit" style="color:#6366f1;"></i> Edit Category
            </h2>`,
            html: `
      <div style="text-align:left; font-family: 'Segoe UI', sans-serif;">

        <label style="font-weight:600; margin-bottom:6px; display:block; color:#374151;">Title</label>
        <input id="swal-cat-name" class="swal2-input"
          placeholder="Enter category title"
          value="${name}"
          style="width:100%; border:1px solid #d1d5db; border-radius:10px; padding:10px; font-size:15px; margin-bottom:18px;" />

        <label style="font-weight:600; margin-bottom:6px; display:block; color:#374151;">Description</label>
        <textarea id="swal-cat-desc"
          placeholder="Enter description"
          style="width:100%; border:1px solid #d1d5db; border-radius:10px; padding:10px; font-size:15px; min-height:100px; resize:none;">${description}</textarea>

      </div>
    `,
            focusConfirm: false,
            width: "480px",
            background: "#f9fafb",
            padding: "1.8rem",
            showCancelButton: true,
            confirmButtonText: '<i class="fas fa-save"></i> Update Category',
            cancelButtonText: '<i class="fas fa-times"></i> Cancel',
            confirmButtonColor: "#4f46e5", // nice indigo
            cancelButtonColor: "#6b7280", // gray
            customClass: {
              popup: "swal2-rounded",
              confirmButton: "btn btn-primary",
              cancelButton: "btn btn-secondary"
            },
            preConfirm: () => {
              const name = document.getElementById("swal-cat-name").value.trim();
              const description = document.getElementById("swal-cat-desc").value.trim();

              if (!name || !description) {
                Swal.showValidationMessage("⚠️ Title and Description are required!");
                return false;
              }
              return { name, description };
            }
          }).then((result) => {
            if (result.isConfirmed) {
              const { name, description } = result.value;

              $.ajax({
                type: "PATCH",
                url: `/admin/categories/${id}`,
                data: { name, description },
                success: function (response) {
                  if (response.success) {
                    Swal.fire({
                      toast: true,
                      position: "top-end",
                      icon: "success",
                      title: "Category updated successfully!",
                      showConfirmButton: false,
                      timer: 2000
                    });

                    // Update UI instantly
                    const row = document.querySelector(`a[onclick*="${id}"]`).closest("tr");
                    row.querySelector("td:nth-child(2)").innerText = name;
                    row.querySelector("td:nth-child(3)").innerText = description;
                  } else {
                    Swal.fire("Error", response.message, "error");
                  }
                },
                error: function () {
                  Swal.fire({
                    icon: "error",
                    title: "Server Error",
                    text: "Please try again later!",
                  });
                },
              });
            }
          });
        }


      </script>