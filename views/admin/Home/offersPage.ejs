<!-- Bootstrap & FontAwesome -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<link rel="stylesheet" href="/css/admin/DashBoard/header.css">
<link rel="stylesheet" href="/css/admin/DashBoard/customerList.css">
<link rel="stylesheet" href="/css/admin/DashBoard/category.css">
<link rel="stylesheet" href="/css/admin/DashBoard/ProductDetails.css">
<link rel="stylesheet" href="/css/admin/DashBoard/pageNavigation.css">

<%- include("../../partials/admin/sidebar") %>
<%- include("../../partials/admin/header") %>
<%- include("../../partials/user/messages") %>

<div class="main-content">

  <!-- Page Header -->
  <div class="content-header">
    <h2>Offers</h2>
    <div class="page-header mb-3 d-flex justify-content-between align-items-center">
      <a onclick="addOfferModal()" class="btn btn-primary">
        <i class="fa fa-plus"></i> Add Offer
      </a>

      <!-- Filter dropdown -->
      <select id="offerFilter" class="form-select w-auto" onchange="filterOffers()">
        <option value="all" <%= !filter || filter === 'all' ? 'selected' : '' %>>All Offers</option>
        <option value="active" <%= filter === 'active' ? 'selected' : '' %>>Active</option>
        <option value="inactive" <%= filter === 'inactive' ? 'selected' : '' %>>Inactive / Expired</option>
      </select>
    </div>
  </div>

  <!-- Offers Table -->
  <div class="table-wrapper table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>#</th>
          <th>Offer Name</th>
          <th>Offer Code</th>
          <th>Discount Type</th>
          <th>Value</th>
          <th>Applies To</th>
          <th>Targets</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% offerData.forEach((offer, i) => {
          const today = new Date();
          const startDate = new Date(offer.startDate);
          const endDate = new Date(offer.endDate);

          let status;
          if (today < startDate && offer.isActive) status = "upcoming";
          else if (today > endDate || offer.isActive == false) status = "inactive";
          else status = "active";

          // Get target names
          let targetNames = [];
          if (offer.appliesTo === "product") {
            targetNames = products
              .filter(p => offer.targetIds.includes(p._id.toString()))
              .map(p => p.name);
          } else if (offer.appliesTo === "category") {
            targetNames = categories
              .filter(c => offer.targetIds.includes(c._id.toString()))
              .map(c => c.name);
          }
        %>
        <tr data-status="<%= status %>">
          <td><%= i + 1 %></td>
          <td class="offer-name"><%= offer.name %></td>
          <td class="offer-code"><%= offer.code %></td>
          <td class="offer-type"><%= offer.discountType %></td>
          <td class="offer-value"><%= offer.discountValue %></td>
          <td class="offer-appliesto"><%= offer.appliesTo %></td>
          <td class="offer-targets"><%- targetNames.join("<br>") %></td>
          <td class="offer-start"><%= startDate.toLocaleDateString() %></td>
          <td class="offer-end"><%= endDate.toLocaleDateString() %></td>
          <td class="status-badge-<%= offer._id %>">
            <% if (status === 'upcoming') { %>
              <span class="badge bg-secondary">Upcoming</span>
            <% } else if (status === 'inactive') { %>
              <span class="badge bg-danger">Expired</span>
            <% } else { %>
              <span class="badge bg-success">Active</span>
            <% } %>
          </td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="editOffer('<%= offer._id %>')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteOffer('<%= offer._id %>')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <% if (currentPage > 1) { %>
      <a href="?page=<%= currentPage - 1 %>"><button class="nav-btn">Prev</button></a>
    <% } else { %>
      <button class="nav-btn" disabled>Prev</button>
    <% } %>

    <% for (let i = 1; i <= totalPages; i++) { %>
      <% if (currentPage === i) { %>
        <button class="page-btn active"><%= i %></button>
      <% } else { %>
        <a href="?page=<%= i %>"><button class="page-btn"><%= i %></button></a>
      <% } %>
    <% } %>

    <% if (currentPage < totalPages) { %>
      <a href="?page=<%= currentPage + 1 %>"><button class="nav-btn">Next</button></a>
    <% } else { %>
      <button class="nav-btn" disabled>Next</button>
    <% } %>
  </div>

</div>

<!-- Global JS Data -->
<script>
  window.offerData = <%- JSON.stringify(offerData) %>;
  window.products = <%- JSON.stringify(products) %>;
  window.categories = <%- JSON.stringify(categories) %>;

  function filterOffers() {
    const filter = document.getElementById("offerFilter").value;
    const rows = document.querySelectorAll("tbody tr");

    rows.forEach(row => {
      const status = row.getAttribute("data-status");
      if (filter === "all") {
        row.style.display = "";
      } else if (filter === "active") {
        row.style.display = status === "active" ? "" : "none";
      } else if (filter === "inactive") {
        row.style.display = status === "inactive" ? "" : "none";
      }
    });
  }
</script>

<script src="/js/admin/Home/offersPage.js"></script>

<style>
  /* Responsive table */
  .table-wrapper { overflow-x: auto; width: 100%; }
  .table-wrapper table { min-width: 1000px; }

  /* SweetAlert2 modal */
  .swal2-popup { width: 90% !important; max-width: 700px !important; }
  .swal-scrollable { max-height: 70vh; overflow-y: auto; }
  .swal2-popup .form-control { width: 100% !important; box-sizing: border-box; }

  /* Mobile-friendly stacked table rows */
  @media (max-width: 768px) {
    .table thead { display: none; }
    .table tbody tr {
      display: block; margin-bottom: 1rem; border: 1px solid #ddd; padding: 0.5rem;
    }
    .table tbody td {
      display: flex; justify-content: space-between; padding: 0.25rem 0.5rem;
      border: none; border-bottom: 1px solid #eee;
    }
    .table tbody td::before {
      content: attr(data-label); font-weight: bold; flex: 1;
    }
  }
</style>
