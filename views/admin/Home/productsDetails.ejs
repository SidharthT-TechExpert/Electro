<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/admin/DashBoard/category.css">
  <link rel="stylesheet" href="/css/admin/DashBoard/ProductDetails.css">
</head>
<body>
  <!-- Sidebar + Header -->
  <%- include("../../partials/admin/sidebar") %>
  <%- include("../../partials/admin/header") %>
  <%- include("../../partials/user/messages") %>

  <div class="admin-page-content">
    <!-- Top Bar -->
    <div class="top-bar d-flex justify-content-between align-items-center flex-wrap gap-2">
      <a href="/admin/products" class="btn btn-outline-primary">
        <i class="fa fa-arrow-left"></i> Back to Products
      </a>
      <div class="btn-group">
        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="fa fa-ellipsis-v"></i> Actions
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="/admin/products/edit/<%= product._id %>"><i class="fa fa-edit text-primary"></i> Edit</a></li>
          <li><a class="dropdown-item text-warning" href="/admin/products/block/<%= product._id %>"><i class="fa fa-ban"></i> Block</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="/admin/products/delete/<%= product._id %>"><i class="fa fa-trash"></i> Delete</a></li>
        </ul>
      </div>
    </div>

    <!-- Product Banner -->
    <div class="product-banner d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h2><%= product?.name %></h2>
        <p class="mb-0">
          <strong>Brand:</strong> <%= product?.brand?.name || "Unbranded" %> &nbsp;|&nbsp; 
          <strong>Category:</strong> <%= product?.category?.name || "Uncategorized" %>
        </p>
      </div>
      <div>
        <span class="badge-status badge-<%= product?.status %>"><%= product?.status %></span>
      </div>
    </div>

    <!-- Info Cards -->
    <div class="info-cards">
      <div class="info-card">
        <h6>Base Price</h6>
        <p>₹<%= (product?.price || 0).toFixed(2) %></p>
      </div>
      <div class="info-card">
        <h6>Total Variants</h6>
        <p><%= product?.variants?.length || 0 %></p>
      </div>
      <div class="info-card">
        <h6>Created At</h6>
        <p><%= product.createdAt?.toDateString() %></p>
      </div>
    </div>

   <%
     const variantFields = (typeof variantField !== "undefined" && variantField) 
       ? variantField 
       : ["color", "material", "size", "stock", "price", "sku", "description", "images"];
   %>

    <!-- Variants Table -->
    <div class="card p-3 mt-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Variants</h5>
        <button class="btn btn-success btn-sm" onclick="document.getElementById('variantFormCard').classList.toggle('d-none')">
          <i class="fa fa-plus"></i> Add Variant
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered variants-table">
          <thead>
            <tr>
              <% variantFields.forEach(f => { %>
                <th><%= f.charAt(0).toUpperCase() + f.slice(1) %></th>
              <% }) %>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if(product.variants.length > 0){ %>
              <% product.variants.forEach(variant => { %>
                <tr>
                  <% variantFields.forEach(f => { %>
                    <td>
                      <% if(f === 'images'){ %>
                        <% if(variant.images && variant.images.length > 0){ %>
                          <% variant.images.forEach(img => { %>
                            <img src="<%= img %>" style="width:50px;height:50px;" class="me-1">
                          <% }) %>
                        <% } else { %>
                          -
                        <% } %>
                      <% } else { %>
                        <%= variant[f] || "-" %>
                      <% } %>
                    </td>
                  <% }) %>
                  <td>
                    <a href="/admin/products/<%= product._id %>/variants/edit/<%= variant._id %>" class="btn btn-sm btn-primary"><i class="fa fa-edit"></i></a>
                    <a href="/admin/products/<%= product._id %>/variants/delete/<%= variant._id %>" class="btn btn-sm btn-danger"><i class="fa fa-trash"></i></a>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr><td colspan="<%= variantFields.length + 1 %>" class="text-center">No variants available</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Add Variant Form -->
    <div class="card p-3 mt-4 d-none" id="variantFormCard">
      <h5>Add Variant</h5>
      <form id="variantForm">
        <div class="row">
          <% variantFields.forEach(f => { %>
            <% if(f !== 'description' && f !== 'images'){ %>
              <div class="col-md-4 mb-3">
                <input type="<%= (f==='price' || f==='stock')?'number':'text' %>" 
                       name="<%= f %>" 
                       class="form-control" 
                       placeholder="<%= f.charAt(0).toUpperCase() + f.slice(1) %>" 
                       <%= f==='price'?'step="0.01"':'' %>>
              </div>
            <% } %>
          <% }) %>
        </div>

        <% if(variantFields.includes('description')){ %>
          <div class="mb-3">
            <textarea name="description" class="form-control" placeholder="Description"></textarea>
          </div>
        <% } %>

        <button type="submit" class="btn btn-primary">Save Variant</button>
      </form>
    </div>

  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>


 document.getElementById("variantForm").addEventListener("submit", async function(e){
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

  // Convert formData → plain object
  const variantData = {};
  let hasEmpty = false;

  formData.forEach((value, key) => {
    if (value === "" || value === null) {
      hasEmpty = true;
    } else {
      if (["price", "stock"].includes(key)) {
        variantData[key] = Number(value);
      } else {
        variantData[key] = value;
      }
    }
  });

  // If any field empty → block submit
  if (hasEmpty) {
    Swal.fire({
      icon: "warning",
      title: "Missing Fields",
      text: "Please fill out all fields before saving!"
    });
    return;
  }

  try {
    const res = await fetch("/admin/products/<%= product._id %>/variants", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(variantData)
    });

    const data = await res.json();

    if(data.success){
      Swal.fire({
        icon: "success",
        title: "Variant Added",
        text: data.message || "Variant saved successfully!"
      }).then(() => location.reload());
    } else {
      Swal.fire({ icon: "error", title: "Failed", text: data.message });
    }
  } catch (err) {
    console.error(err);
    Swal.fire({ icon: "error", title: "Server Error", text: "Try again later." });
  }
});

  </script>
</body>
</html>
