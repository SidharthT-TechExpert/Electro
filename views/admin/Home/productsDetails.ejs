<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/admin/DashBoard/category.css">
  <link rel="stylesheet" href="/css/admin/DashBoard/ProductDetails.css">
</head>
<body>
  <!-- Sidebar + Header -->
  <%- include("../../partials/admin/sidebar") %>
  <%- include("../../partials/admin/header") %>
  <%- include("../../partials/user/messages") %>

  <!-- Page Content -->
  <div class="admin-page-content">

    <!-- Top Bar -->
    <div class="top-bar d-flex justify-content-between align-items-center flex-wrap gap-2">
      <a href="/admin/products" class="btn btn-outline-primary">
        <i class="fa fa-arrow-left"></i> Back to Products
      </a>

      <div class="btn-group">
        <button 
          type="button" 
          class="btn btn-sm btn-outline-secondary dropdown-toggle" 
          data-bs-toggle="dropdown" 
          aria-expanded="false">
          <i class="fa fa-ellipsis-v"></i> Actions
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <a class="dropdown-item" href="/admin/products/edit/<%= product._id %>">
              <i class="fa fa-edit text-primary"></i> Edit
            </a>
          </li>
          <li>
            <a class="dropdown-item text-warning" href="/admin/products/block/<%= product._id %>">
              <i class="fa fa-ban"></i> Block
            </a>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item text-danger" href="/admin/products/delete/<%= product._id %>">
              <i class="fa fa-trash"></i> Delete
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Product Banner -->
    <div class="product-banner d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h2><%= product?.name %></h2>
        <p class="mb-0">
          <strong>Brand:</strong> <%= product?.brand?.name || "Unbranded" %> &nbsp;|&nbsp; 
          <strong>Category:</strong> <%= product?.category?.name || "Uncategorized" %>
        </p>
      </div>
      <div>
        <span class="badge-status badge-<%= product?.status %>"><%= product?.status %></span>
      </div>
    </div>

    <!-- Info Cards -->
    <div class="info-cards">
      <div class="info-card">
        <h6>Base Price</h6>
        <p>₹<%= (product?.price || 0).toFixed(2) %></p>
      </div>
      <div class="info-card">
        <h6>Total Variants</h6>
        <p><%= product?.variants?.length || 0 %></p>
      </div>
      <div class="info-card">
        <h6>Created At</h6>
        <p><%= product.createdAt?.toDateString() %></p>
      </div>
    </div>

    <!-- Variants Table -->
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Variants</h5>
        <button class="btn btn-success btn-sm" onclick="document.getElementById('variantFormCard').classList.toggle('d-none')">
          <i class="fa fa-plus"></i> Add Variant
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered variants-table">
          <thead>
            <tr>
              <% if (product?.category?.variantAttributes?.length > 0) { %>
                <% product.category.variantAttributes.forEach(attr => { %>
                  <th><%= attr %></th>
                <% }) %>
              <% } %>
              <th>Stock</th>
              <th>Price</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (product?.variants?.length > 0) { %>
              <% product.variants.forEach(variant => { %>
                <tr>
                  <% if (product?.category?.variantAttributes?.length > 0) { %>
                    <% product.category.variantAttributes.forEach(attr => { %>
                      <td><%= variant[attr] || "-" %></td>
                    <% }) %>
                  <% } %>
                  <td><%= variant.stock ?? 0 %></td>
                  <td>₹<%= (variant.price ?? product.price ?? 0).toFixed(2) %></td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary"><i class="fa fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger"><i class="fa fa-trash"></i></button>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="<%= (product?.category?.variantAttributes?.length || 0) + 3 %>" class="no-variants">No variants available</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Add Variant Form (Auto fields from category) -->
    <div class="card p-3 mt-4 d-none" id="variantFormCard">
      <h5>Add Variant</h5>
      <form id="variantForm" method="POST" action="/admin/products/<%= product._id %>/variants">

        <% if (product?.category?.variantAttributes?.length > 0) { %>
          <% product.category.variantAttributes.forEach(attr => { %>
            <div class="mb-3">
              <label class="form-label"><%= attr %></label>
              <input type="text" name="variant[<%= attr %>]" class="form-control" placeholder="Enter <%= attr %>">
            </div>
          <% }) %>
        <% } %>

        <div class="mb-3">
          <label class="form-label">Stock</label>
          <input type="number" name="variant[stock]" class="form-control" placeholder="Enter Stock">
        </div>
        <div class="mb-3">
          <label class="form-label">Price</label>
          <input type="number" step="0.01" name="variant[price]" class="form-control" placeholder="Enter Price">
        </div>

        <button type="submit" class="btn btn-primary">Save Variant</button>
      </form>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
