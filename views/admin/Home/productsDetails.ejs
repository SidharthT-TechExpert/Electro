<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/admin/DashBoard/category.css">
  <link rel="stylesheet" href="/css/admin/DashBoard/ProductDetails.css">
  <style>
    .swal-wide {
      width: 60% !important;
    }

    .image-upload-placeholder {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px dashed #6c757d;
      padding: 10px;
      width: 50px;
      height: 50px;
    }

    .variant-image-container img {
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <!-- Sidebar + Header -->
  <%- include("../../partials/admin/sidebar", { activePage: activePage }) %>
    <%- include("../../partials/admin/header") %>
      <%- include("../../partials/user/messages") %>

        <div class="admin-page-content">
          <!-- Top Bar -->
          <div class="top-bar d-flex justify-content-between align-items-center flex-wrap gap-2">
            <a href="/admin/products" class="btn btn-outline-primary">
              <i class="fa fa-arrow-left"></i> Back to Products
            </a>
            <div class="btn-group">
              <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fa fa-ellipsis-v"></i> Actions
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="/admin/products/edit/<%= product._id %>"><i
                      class="fa fa-edit text-primary"></i> Edit</a></li>
                <li><a class="dropdown-item text-warning" href="/admin/products/block/<%= product._id %>"><i
                      class="fa fa-ban"></i> Block</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item text-danger" href="/admin/products/delete/<%= product._id %>"><i
                      class="fa fa-trash"></i> Delete</a></li>
              </ul>
            </div>
          </div>

          <!-- Product Banner -->
          <div class="product-banner d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
              <h2>
                <%= product?.name %>
              </h2>
              <p class="mb-0">
                <strong>Brand:</strong>
                <%= product?.brand?.name || "Unbranded" %> &nbsp;|&nbsp;
                  <strong>Category:</strong>
                  <%= product?.category?.name || "Uncategorized" %>
              </p>
            </div>
            <div>
              <span class="badge-status badge-<%= product?.status %>">
                <%= product?.status %>
              </span>
            </div>
          </div>

          <!-- Info Cards -->
          <div class="info-cards">
            <div class="info-card">
              <h6>Base Price</h6>
              <p>â‚¹<%= (product?.price || 0).toFixed(2) %>
              </p>
            </div>
            <div class="info-card">
              <h6>Total Variants</h6>
              <p>
                <%= variants?.length || 0 %>
              </p>
            </div>
            <div class="info-card">
              <h6>Created At</h6>
              <p>
                <%= product.createdAt?.toDateString() %>
              </p>
            </div>
          </div>

          <% const variantFields=(typeof variantField !=="undefined" && variantField) ? variantField :
            ["color","material","size","stock","price","sku","description","images","ram","storage","battery","display","os"];
            %>

            <!-- Variants Table -->
            <div class="card p-3 mt-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Variants</h5>
                <button class="btn btn-success btn-sm" onclick="openVariantPopup()">
                  <i class="fa fa-plus"></i> Add Variant
                </button>
              </div>
              <div class="table-responsive">
                <table class="table table-bordered variants-table">
                  <thead>
                    <tr>
                      <% variantFields.forEach(f=>{ %><th>
                          <%= f.charAt(0).toUpperCase() + f.slice(1) %>
                        </th>
                        <% }) %>
                          <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if(variants.length>0){ %>
                      <% variants.forEach(variant=>{ %>
                        <tr>
                          <% variantFields.forEach(f=>{ %>
                            <td>
                              <% if(f==='images' ){ %>
                                <div class="variant-image-container" data-variant-id="<%= variant._id %>">
                                  <% if(variant.product_image && variant.product_image.length>0){ %>
                                    <div class="existing-images">
                                      <% variant.product_image.forEach(img=>{ %>
                                        <div class="image-item">
                                          <img src="<%= img %>" style="width:50px;height:50px;" class="me-1">
                                          <button class="remove-existing-image" data-image="<%= img %>"
                                            data-variant-id="<%= variant._id %>">
                                            <i class="fa fa-times"></i>
                                          </button>
                                        </div>
                                        <% }) %>
                                    </div>
                                    <% } %>
                                      <div class="add-image-box" data-variant-id="<%= variant._id %>">
                                        <div onclick="addImg(`<%= variant._id %>`)" class="image-upload-placeholder">
                                          <i class="fa fa-plus"></i><span>Add</span>
                                        </div>
                                      </div>
                                </div>
                                <% } else { %>
                                  <%= variant[f] ?? variant.specifications?.get(f) ?? "-" %>
                                    <% } %>
                            </td>
                            <% }) %>
                              <td>
                                <a href="javascript:void(0);" class="btn btn-sm btn-primary"
                                  onclick='openVariantPopup(<%- JSON.stringify(variant) %>)'><i
                                    class="fa fa-edit"></i></a>
                                <a onclick="deleteVariant('<%= variant._id %>')" class="btn btn-sm btn-danger"><i
                                    class="fa fa-trash"></i></a>
                              </td>
                        </tr>
                        <% }) %>
                          <% } else { %>
                            <tr>
                              <td colspan="<%= variantFields.length + 1 %>" class="text-center">No variants available
                              </td>
                            </tr>
                            <% } %>
                  </tbody>
                </table>
              </div>
            </div>
        </div>

        <!-- JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

        <script>
          function openVariantPopup(variantData = {}) {
            console.log(variantData)
            const variantFields = JSON.parse('<%- JSON.stringify(variantFields) %>');
            let formHtml = `<form id="swalVariantForm" class="row g-3">`;

            variantFields.forEach(f => {
              if (!['description', 'images'].includes(f)) {
                const type = ['price', 'stock'].includes(f) ? 'number' : 'text';
                const step = f === 'price' ? 'step="0.01"' : '';
                formHtml += `
            <div class="col-md-4">
              <input type="${type}" name="${f}" class="form-control" ${step}
                value="${variantData[f] || variantData.specifications?.[f] || ''}"
                placeholder="${f.charAt(0).toUpperCase() + f.slice(1)}" required>
            </div>`;
              }
            });

            if (variantFields.includes('description')) {
              formHtml += `<div class="col-12">
            <textarea name="description" class="form-control" placeholder="Description">${variantData.description || ''}</textarea>
          </div>`;
            }

            formHtml += `</form>`;

            Swal.fire({
              title: variantData._id ? 'Edit Variant' : 'Add Variant',
              html: formHtml,
              customClass: 'swal-wide',
              showCancelButton: true,
              confirmButtonText: variantData._id ? 'Update' : 'Save',
              focusConfirm: false,
              preConfirm: async () => {
                const form = document.getElementById('swalVariantForm');
                const fd = new FormData(form);
                const data = {};
                let hasEmpty = false;

                fd.forEach((value, key) => {
                  if (!value) hasEmpty = true;
                  data[key] = ['price', 'stock'].includes(key) ? Number(value) : value;
                });

                if (hasEmpty) {
                  Swal.showValidationMessage('Please fill out all fields!');
                  return false;
                }

                // Check SKU uniqueness via server
                const res = await fetch('/admin/products/variants/check-sku', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ sku: data.sku, variantId: variantData._id })
                });
                const json = await res.json();
                if (json.exists) {
                  Swal.showValidationMessage('SKU already exists!');
                  return false;
                }
                return data;
              }
            }).then((result) => {
              if (result.isConfirmed) saveVariant(result.value, variantData._id);
            });
          }

          async function saveVariant(data, variantId = null) {
            const url = variantId
              ? `/admin/products/<%= product._id %>/variants/edit/${variantId}`
              : `/admin/products/<%= product._id %>/variants`;
            const method = variantId ? 'PATCH' : 'POST';
            try {
              const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
              const json = await res.json();
              if (json.success) {
                Swal.fire({ icon: 'success', title: variantId ? 'Variant Updated' : 'Variant Added', text: json.message || 'Saved successfully!', timer: 1500, showConfirmButton: false })
                  .then(() => location.reload());
              } else {
                Swal.fire({ icon: 'error', title: 'Failed', text: json.message });
              }
            } catch (err) {
              console.error(err);
              Swal.fire({ icon: 'error', title: 'Server Error', text: 'Try again later.' });
            }
          }

          function deleteVariant(id) {
            Swal.fire({
              title: "Are you sure?",
              text: "This will permanently delete the variant and all its associated images.",
              icon: "warning",
              showCancelButton: true,
              confirmButtonColor: "#d33",
              cancelButtonColor: "#6c757d",
              confirmButtonText: "Yes, delete it!"
            }).then((result) => {
              if (result.isConfirmed) {
                fetch(`/admin/products/variants/delete/${id}`, { method: 'DELETE' })
                  .then(res => res.json())
                  .then(response => {
                    if (response.success) {
                      Swal.fire({ icon: "success", title: "Variant Deleted", text: "Variant deleted successfully.", timer: 2000, showConfirmButton: false });
                      document.querySelector(`a[onclick="deleteVariant('${id}')"]`).closest("tr").remove();
                    } else {
                      Swal.fire("Error", response.message, "error");
                    }
                  })
                  .catch(() => Swal.fire({ icon: "error", title: "Server Error", text: "Try again later." }));
              }
            });
          }
        </script>
</body>

</html>