<link rel="stylesheet" href="/css/home.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<%- include("../partials/user/header") %>
  <%- include("../partials/user/messages") %>

    <main class="homepage">

      <!-- ðŸŒŸ Hero Slider -->
      <section class="hero-banner position-relative">
        <div class="hero-slider">
          <% if (bannerData.length>0){ %>
            <% bannerData.forEach((banner,index)=>{ %>
              <div class="hero-slide <%= index===0?'active':'' %>" style="background-image:url('<%= banner.image %>')">
                <div class="hero-overlay"></div>
                <div class="hero-content container">
                  <% if(banner.subtitle){ %>
                    <h5>
                      <%= banner.subtitle %>
                    </h5>
                    <% } %>
                      <% if(banner.title){ %>
                        <h1>
                          <%= banner.title %>
                        </h1>
                        <% } %>
                          <% if(banner.description){ %>
                            <p>
                              <%= banner.description %>
                            </p>
                            <% } %>
                              <% if(banner.buttonText && banner.buttonLink){ %>
                                <a href="<%= banner.buttonLink %>" class="shop-btn">
                                  <%= banner.buttonText %>
                                </a>
                                <% } %>
                </div>
              </div>
              <% }) %>
                <% } else { %>
                  <div class="hero-slide active" style="background-image:url('/img/header-img.jpg')">
                    <div class="hero-overlay"></div>
                    <div class="hero-content container">
                      <h5>Welcome to ElectroHub</h5>
                      <h1>Your One-Stop Electronics Store</h1>
                      <p>Explore the latest gadgets, phones, and accessories!</p>
                      <a href="/shop" class="shop-btn">Shop Now</a>
                    </div>
                  </div>
                  <% } %>
        </div>
        <button class="hero-nav prev"><i class="fa-solid fa-chevron-left"></i></button>
        <button class="hero-nav next"><i class="fa-solid fa-chevron-right"></i></button>
        <div class="hero-dots"></div>
      </section>

      <!-- ðŸ§© Categories -->
      <section class="categories">
        <div class="container cat-container">
          <div class="cat-box active"><i class="fas fa-mobile-alt fa-2x"></i>
            <p>Phones</p>
          </div>
          <div class="cat-box"><i class="fas fa-laptop fa-2x"></i>
            <p>Computers</p>
          </div>
          <div class="cat-box"><i class="fas fa-clock fa-2x"></i>
            <p>SmartWatch</p>
          </div>
          <div class="cat-box"><i class="fas fa-camera fa-2x"></i>
            <p>Camera</p>
          </div>
          <div class="cat-box"><i class="fas fa-gamepad fa-2x"></i>
            <p>Gaming</p>
          </div>
          <div class="cat-box"><i class="fas fa-headphones fa-2x"></i>
            <p>Headphones</p>
          </div>
        </div>
      </section>

      <!-- ðŸ›ï¸ Products -->
      <section class="products">
        <div class="container">
          <ul class="nav nav-tabs mb-4" id="productTabs">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#new">New Arrivals</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#best">Best Sellers</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#hot">Hot Sales</a></li>
          </ul>

          <div class="tab-content">

            <!-- Loop function for each tab -->
            <% const tabs={ new: newProducts, best: bestSellers, hot: hotSales }; %>
              <% Object.keys(tabs).forEach(tabName=> { %>
                <div id="<%= tabName %>" class="tab-pane fade <%= tabName==='new'?'show active':'' %>">
                  <div class="product-grid">
                    <% tabs[tabName].forEach(product=> { %> <!-- âœ… use tabs[tabName] -->
                      <div class="product-card" onclick="location.href='/product/<%= product._id %>'">
                        <div class="product-img-wrapper fixed-img"
                          style="background-image: url('<%= product.variantImage || product.image %>');">
                          <% if(product.offers){ %>
                            <div class="product-discount-badgeX">
                              <% if(product.appliedDiscountType==='Percentage' ){ %>
                                -<%= product.discountPercentage %>%
                                  <% } else { %>
                                    -â‚¹<%= product.discountPercentage %>
                                      <% } %>
                            </div>
                            <% } %>
                              <div class="product__hover">
                                <button href="#"
                                  id="wishlist-btn-<%= product._id %>-<%= product.variants && product.variants[0]?._id || 'no-variant' %>"
                                  class="wishlist-toggle" data-product-id="<%= product._id %>"
                                  data-variant-id="<%= product.variants && product.variants[0]?._id || '' %>"
                                  onclick="event.stopPropagation(); addToWishlist('<%= product._id %>', '<%= product.variants && product.variants[0]?._id || '' %>');"
                                  style="color: <%= user?.wishlists?.products?.some(p => 
       String(p.productId) === String(product._id) && 
       String(p.variantId) === String(product.variants?.[0]?._id)
     ) ? 'red' : '#1f1f1f' %>;">
                                  <i class="<%= user?.wishlists?.products?.some(p => 
       String(p.productId) === String(product._id) && 
       String(p.variantId) === String(product.variants?.[0]?._id)
     ) ? 'fas' : 'far' %> fa-heart"></i>
                                </button>


                                <button href="#" class="add-to-cart" data-product-id="<%= product._id %>"
                                  data-variant-id="<%= product.variants && product.variants[0]?._id || '' %>"
                                  onclick="event.stopPropagation();">
                                  <i class="fa fa-shopping-cart"></i>
                                </button>

                              </div>
                        </div>
                        <div class="text-center p-3">
                          <h6>
                            <%= product.name %>
                          </h6>
                          <span style="color: green; font-weight: bold;">FREE delivery!</span>
                          <div class="price-wrapper">
                            <span style="font-size: larger; font-weight: bold; color: black;">â‚¹<%= (product.finalPrice
                                || product.price).toFixed(0) %>
                            </span>
                            <% if(product.offers?.length> 0){ %>
                              <span class="old-price">â‚¹<%= product.mainPrice %></span>
                              <span style="color: green; font-weight: bolder; font-size: smaller;">
                                <%= product.discountPercentage %>% off
                              </span>
                              <% } %>
                          </div>
                        </div>
                      </div>
                      <% }) %>
                  </div>
                </div>
                <% }) %>


          </div>
        </div>
      </section>

      <!-- ðŸš€ Features -->
      <section class="features text-center">
        <div class="container d-flex flex-wrap justify-content-center">
          <div class="feature-box">
            <div class="icon"><i class="fas fa-truck"></i></div>
            <h6>Free Shipping</h6>
            <p>On all orders over $50</p>
          </div>
          <div class="feature-box">
            <div class="icon"><i class="fas fa-headset"></i></div>
            <h6>24/7 Support</h6>
            <p>Weâ€™re here to help anytime</p>
          </div>
          <div class="feature-box">
            <div class="icon"><i class="fas fa-shield-alt"></i></div>
            <h6>Secure Payment</h6>
            <p>100% secure payment</p>
          </div>
        </div>
      </section>

    </main>

    <%- include("../partials/user/footer") %>

      <style>
        .product__hover button.add-to-cart:hover {
          background: #2874f0;
          color: #fff;
        }

        .product-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
          gap: 20px;
        }

        .product-card {
          position: relative;
          transition: transform .3s, box-shadow .3s;
          cursor: pointer;
          background: #fff;
          border-radius: 8px;
          overflow: hidden;
        }

        .product-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 20px rgba(235, 235, 235, 0.15);

        }

        .product-img-wrapper {
          position: relative;
          overflow: hidden;
        }

        .product__hover {
          position: absolute;
          top: 12px;
          right: 12px;
          display: flex;
          flex-direction: column;
          gap: 8px;
          opacity: 0;
          transition: opacity 0.3s;
          z-index: 10;
        }

        .product-card:hover .product__hover {
          opacity: 1;
        }

        .product__hover button {
          width: 36px;
          height: 36px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 14px;
          background: #fff;
          color: #878787;
          box-shadow: 0 1px 4px rgba(0, 0, 0, .2);
          text-decoration: none;
          transition: all 0.2s;
        }

        .product__hover button:hover {
          transform: scale(1.1);
        }

        .product__hover button.add-to-cart {
          color: #2874f0;
        }

        .product__hover button.wishlist-toggle:hover {
          background: #ff6161;
          color: #fff;
        }


        .product-discount-badge {
          position: absolute;
          top: 10px;
          left: 10px;
          background: red;
          color: #fff;
          padding: 5px 8px;
          font-size: 12px;
          font-weight: bold;
          border-radius: 4px;
        }

        .old-price {
          text-decoration: line-through;
          color: #888;
          margin-left: 10px;
        }

        .fixed-img {
          width: 100%;
          /* or a fixed px value like 300px */
          height: 250px;
          /* fixed height */
          background-size: cover;
          /* makes image cover entire div */
          background-position: center;
          /* centers image */
          border-radius: 5px;
          /* optional: rounded corners */
          overflow: hidden;
        }

        .product-card:hover .text-center h6 {
          color: #2874f0;
        }
      </style>



      <!-- Axios CDN -->
      <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
      <script src="/js/main.js"></script>

      <script>
        // Hero slider
        document.addEventListener("DOMContentLoaded", () => {
          const slides = document.querySelectorAll(".hero-slide");
          const dotsContainer = document.querySelector(".hero-dots");
          let currentSlide = 0, slideInterval;
          if (!slides || slides.length === 0) return;
          const dots = [];
          slides.forEach((_, i) => {
            const dot = document.createElement("span");
            if (i === 0) dot.classList.add("active");
            dotsContainer.appendChild(dot);
            dot.addEventListener("click", () => showSlide(i));
            dots.push(dot);
          });
          function showSlide(index) { slides.forEach((s, i) => s.classList.toggle("active", i === index)); dots.forEach((d, i) => d.classList.toggle("active", i === index)); currentSlide = index; }
          function nextSlide() { showSlide((currentSlide + 1) % slides.length); }
          function prevSlide() { showSlide((currentSlide - 1 + slides.length) % slides.length); }
          document.querySelector(".hero-nav.next").addEventListener("click", nextSlide);
          document.querySelector(".hero-nav.prev").addEventListener("click", prevSlide);
          function autoPlay() { slideInterval = setInterval(nextSlide, 5000); }
          document.querySelector(".hero-banner").addEventListener("mouseenter", () => clearInterval(slideInterval));
          document.querySelector(".hero-banner").addEventListener("mouseleave", autoPlay);
          document.addEventListener("keydown", (e) => { if (e.key === "ArrowRight") nextSlide(); if (e.key === "ArrowLeft") prevSlide(); });
          autoPlay();
        });
        const user = <%- user ? JSON.stringify(user) : 'null' %>;

        // Wishlist button AJAX with SweetAlert
        let wishlistLock = {}; // prevent rapid repeated clicks

        async function addToWishlist(productId, variantId) {
          if (!user) {
            return Swal.fire({
              icon: 'info',
              title: "Please login first!",
              showConfirmButton: true
            }).then(() => location.href = '/logIn');
          }

          if (!productId || !variantId) {
            return Swal.fire({
              icon: 'error',
              title: 'Product or variant not selected!',
              showConfirmButton: true
            });
          }

          const key = `${productId}-${variantId}`;
          if (wishlistLock[key]) return;
          wishlistLock[key] = true;

          const wishlistBtn = document.querySelector(`#wishlist-btn-${key}`);
          if (!wishlistBtn) {
            wishlistLock[key] = false;
            return;
          }

          const heartIcon = wishlistBtn.querySelector('i');
          const currentlyAdded = heartIcon.classList.contains('fas');

          // TEMP UI toggle
          heartIcon.classList.toggle('fas', !currentlyAdded);
          heartIcon.classList.toggle('far', currentlyAdded);
          wishlistBtn.style.color = !currentlyAdded ? 'red' : '#1f1f1f';

          try {
            const { data } = await axios.post('/shop/wishlist', { productId, variantId });
            const countEl = document.getElementById('wishlist-count');

            if (data.success) {
              const removed = !!data.removed;

              heartIcon.classList.toggle('fas', !removed);
              heartIcon.classList.toggle('far', removed);
              wishlistBtn.style.color = removed ? '#1f1f1f' : 'red';

              // âœ… Update wishlist count dynamically
              if (countEl) {
                let current = parseInt(countEl.innerText) || 0;
                countEl.innerText = removed ? Math.max(current - 1, 0) : current + 1;
              }
            } else {
              heartIcon.classList.toggle('fas', currentlyAdded);
              heartIcon.classList.toggle('far', !currentlyAdded);
              wishlistBtn.style.color = currentlyAdded ? 'red' : '#1f1f1f';
              Swal.fire({ icon: 'error', title: data.message || 'Something went wrong!', showConfirmButton: true });
            }
          } catch (err) {
            heartIcon.classList.toggle('fas', currentlyAdded);
            heartIcon.classList.toggle('far', !currentlyAdded);
            wishlistBtn.style.color = currentlyAdded ? 'red' : '#1f1f1f';
            console.error('Wishlist update error:', err);
            Swal.fire({ icon: 'error', title: 'Error updating wishlist', timer: 1500, showConfirmButton: false });
          } finally {
            setTimeout(() => { wishlistLock[key] = false; }, 500);
          }
        }

        // Prevent card click on action buttons and call Axios functions
        document.querySelectorAll('.wishlist-toggle').forEach(btn => {
          btn.addEventListener('click', function (e) {
            e.stopPropagation();
            addToWishlist(this.dataset.productId, this.dataset.variantId);
          });
        });


      </script>