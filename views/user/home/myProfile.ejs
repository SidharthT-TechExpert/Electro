<link rel="stylesheet" href="/css/home.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<%- include("../partials/user/header") %>
  <%- include("../partials/user/messages") %>

    <main class="profile-page container my-5">
      <div class="row">
        <!-- Sidebar -->
        <%- include("../partials/user/sideBar") %>

          <!-- Main Profile Section -->
          <section class="col-md-9">
            <div class="card shadow-sm p-4 border-0">
              <h5 class="text-danger fw-semibold mb-4">Edit Your Profile</h5>

              <!-- ✅ Profile Photo Upload -->
              <div class="text-center mb-4">
                <img id="profilePreview"
                  src="<%= user.profilePhoto ? '/profile-photo/' + user.profilePhoto : '/uploads/img/user.png' %>"
                  alt="Profile Photo" class="rounded-circle border" width="120" height="120" style="object-fit: cover;">
                <div class="mt-2">
                  <label class="btn btn-outline-danger btn-sm">
                    <i class="fa fa-camera"></i> Change Photo
                    <input name="profilePhoto" id="profilePhotoInput" hidden>
                  </label>
                </div>
              </div>

              <!-- Name -->
              <div class="mb-3">
                <label class="form-label fw-semibold">Name
                  <a onclick="editName('<%= user.name %>','<%= user._id %>' )" class="text-primary small ms-1">Edit</a>
                </label>
                <input type="text" class="form-control" value="<%= user.name %>" readonly>
              </div>

              <!-- Password Changes -->
              <h6 class="fw-bold mt-4 mb-3">Password Changes</h6>
              <form id="passwordForm" onsubmit="return ChangePassword(this)">
                <div class="mb-3">
                  <input type="password" name="cPassword" class="form-control" placeholder="Current Password">
                </div>
                <div class="mb-3">
                  <input type="password" name="Password" class="form-control" placeholder="New Password">
                </div>
                <div class="mb-3">
                  <input type="password" name="confirmPassword" class="form-control" placeholder="Confirm New Password">
                </div>
                <div class="d-flex justify-content-end gap-2">
                  <button type="button" onclick="this.form.reset()" class="btn btn-outline-dark">Cancel</button>
                  <button type="submit" class="btn btn-danger fw-semibold">Update Password</button>
                </div>
              </form>

              <!-- Email & Phone -->
              <div class="row mt-4">
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-semibold">Email
                    <a onclick="editEmail('<%= user.email %>', '<%= user.id %>')"
                      class="text-primary small ms-1">Edit</a>
                  </label>
                  <input type="email" class="form-control" value="<%= user.email %>" readonly>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label fw-semibold">Phone
                    <a onclick="editPhone('<%= user.phone %>')" class="text-primary small ms-1">Edit</a>
                  </label>
                  <input type="text" class="form-control" value="<%= user.phone %>" readonly>
                </div>
              </div>
            </div>
          </section>
      </div>
    </main>

    <%- include("../partials/user/footer") %>

      <style>
        .swal-popup-professional {
          font-family: 'Segoe UI', sans-serif;
          font-size: 16px;
        }

        .swal-title-professional {
          font-weight: 600;
          font-size: 18px;
        }

        .swal-text-professional {
          color: #555;
        }

        .swal-btn-professional {
          background-color: #007bff !important;
          color: #fff !important;
          font-weight: 500;
        }

        .card input[readonly] {
          background: #f8f8f8;
        }

        .btn-danger {
          background: #e63946;
          border: none;
        }

        .btn-danger:hover {
          background: #c92c3d;
        }
      </style>

      <!-- Include SweetAlert2 + Cropper.js -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
      <script src="/js/main.js"></script>

      <script>
        function ChangePassword(f) {
          const cPassword = f.cPassword.value.trim();   // current password
          const newPassword = f.Password.value.trim();  // new password
          const confirmPassword = f.confirmPassword.value.trim(); // confirmation

          // Validation: empty fields
          if (!cPassword || !newPassword || !confirmPassword) {
            Swal.fire({
              icon: "warning",
              title: "Missing Fields",
              text: "Please fill in all password fields.",
            });
            return false;
          }

          // Validation: minimum length
          if (newPassword.length < 8) {
            Swal.fire({
              icon: "error",
              title: "Weak Password",
              text: "Password must be at least 8 characters long.",
            });
            return false;
          }

          // Validation: must contain at least one number and one special character
          const hasNumber = /[0-9]/.test(newPassword);
          const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(newPassword);

          if (!hasNumber || !hasSpecialChar) {
            Swal.fire({
              icon: "error",
              title: "Weak Password",
              text: "Password must contain at least one number and one special character.",
            });
            return false;
          }

          // Validation: confirm password match
          if (newPassword !== confirmPassword) {
            Swal.fire({
              icon: "error",
              title: "Password Mismatch",
              text: "New password and confirmation do not match.",
            });
            return false;
          }

          // Validation: new password should differ from current password
          if (newPassword === cPassword) {
            Swal.fire({
              icon: "info",
              title: "Same Password",
              text: "New password must be different from your current password.",
            });
            return false;
          }

          // Send data to backend
          fetch("/change-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cPassword, newPassword }),
          })
            .then((res) => res.json()) // ✅ parse JSON first
            .then((response) => {
              if (response.success) {
                Swal.fire({
                  icon: "success",
                  title: "Password Updated!",
                  text: response.message || "Your password was changed successfully.",
                  timer: 1500,
                  showConfirmButton: false,
                }).then(() => location.reload());
              } else {
                Swal.fire({
                  icon: "error",
                  title: "Error",
                  text: response.message || "Unable to change password.",
                });
              }
            })
            .catch((error) => {
              console.error("Error changing password:", error);
              Swal.fire({
                icon: "error",
                title: "Server Error",
                text: "Something went wrong. Please try again later.",
              });
            });

          return false; // ✅ prevent form reload
        }

        async function editPhone(currentPhone) {
          // Ask for new phone number
          const { value: newPhone } = await Swal.fire({
            title: "Enter New Phone Number",
            input: "number",
            inputLabel: "We’ll send an OTP to this number",
            inputValue: currentPhone,
            inputPlaceholder: "Enter new phone number",
            confirmButtonText: "Send OTP",
            showCancelButton: true,
            inputValidator: (value) => {
              if (!/^[0-9]{10}$/.test(value)) {
                return "Please enter a valid 10-digit phone number.";
              }
            },
          });

          if (!newPhone) return;

          // Step 2: Send OTP request
          const otpResponse = await fetch("/send-otp", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone: newPhone }),
          }).then((res) => res.json());

          if (!otpResponse.success) {
            return Swal.fire("Error", otpResponse.message || "Failed to send OTP", "error");
          } else {
            Swal.fire({
              icon: 'success',
              text: otpResponse.message,
              timer: 1500
            });
          }



          // Step 3: Ask user to enter OTP
          const { value: otp } = await Swal.fire({
            title: "Enter OTP",
            input: "text",
            inputPlaceholder: "Enter 6-digit OTP",
            confirmButtonText: "Verify OTP",
            showCancelButton: true,
            inputValidator: (value) => {
              if (!/^[0-9]{6}$/.test(value)) {
                return "Please enter a valid 6-digit OTP.";
              }
            },
          });

          if (!otp) return;

          // Step 4: Verify OTP
          const verifyResponse = await fetch("/verifyOTP", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone: newPhone, otp }),
          }).then((res) => res.json());

          if (verifyResponse.success) {
            Swal.fire({
              icon: "success",
              title: "Phone Updated!",
              text: "Your phone number has been successfully updated.",
              timer: 1500,
              showConfirmButton: false,
            }).then(() => location.reload());
          } else {
            Swal.fire("Error", verifyResponse.message || "Invalid OTP", "error");
          }
        }

        async function editEmail(currentEmail, id) {
          const { value: newEmail } = await Swal.fire({
            title: "Enter New Email Address",
            input: "email",
            inputLabel: "We’ll send an OTP to this email",
            inputValue: currentEmail || "",
            inputPlaceholder: "Enter new email address",
            confirmButtonText: "Send OTP",
            showCancelButton: true,
            inputValidator: (value) => {
              if (!value) return "Please enter an email address.";
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!emailRegex.test(value)) return "Please enter a valid email address.";
            },
          });

          if (!newEmail) return;

          try {
            // ✅Send OTP
            const response = await fetch("/send-email-otp", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email: newEmail, id }),
            }).then((res) => res.json());

            if (!response.success) {
              return Swal.fire("❌ Error", response.message || "Failed to send OTP.", "error");
            }

            await Swal.fire({
              icon: "success",
              text: `OTP has been sent to ${newEmail}`,
              timer: 1500,
              showConfirmButton: false
            });

            // ✅ Enter OTP
            const { value: otp } = await Swal.fire({
              title: "Enter OTP",
              input: "text",
              inputPlaceholder: "Enter 6-digit OTP",
              confirmButtonText: "Verify OTP",
              showCancelButton: true,
              inputValidator: (value) => {
                if (!/^[0-9]{6}$/.test(value)) {
                  return "Please enter a valid 6-digit OTP.";
                }
              },
            });

            if (!otp) return;

            // ✅ Verify OTP
            const verifyResponse = await fetch("/verifyEmail_OTP", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ otp, email: newEmail }),
            }).then((res) => res.json());

            if (verifyResponse.success) {
              console.log(verifyResponse.success)
              Swal.fire({
                icon: "success",
                title: "Email Updated!",
                text: "Your email has been successfully updated.",
                timer: 1500,
                showConfirmButton: false,
              }).then(() => location.reload());
            } else {
              Swal.fire("❌ Error", verifyResponse.message || "Invalid OTP.", "error");
            }
          } catch (error) {
            console.error("Error sending or verifying OTP:", error);
            Swal.fire("⚠️ Error", "Something went wrong. Please try again.", "error");
          }
        }

        const photoInput = document.getElementById("profilePhotoInput");

        let cropper = null;

        photoInput.addEventListener("click", async () => {
          let cropper;

          Swal.fire({
            title: "Upload & Crop Image",
            html: `
      <input type="file" id="swalImageFile" accept="image/*" class="swal2-input">
      <div id="previewContainer" style="margin-top:15px; display:none;">
        <img id="previewImage" style="max-width:100%; border-radius:10px;"/>
      </div>
    `,
            showCancelButton: true,
            confirmButtonText: "Upload",
            allowOutsideClick: false,   // ❌ Only close via Cancel
            allowEscapeKey: false,      // ❌ Disable ESC close
            didOpen: () => {
              const fileInput = document.getElementById("swalImageFile");
              const previewContainer = document.getElementById("previewContainer");
              const previewImage = document.getElementById("previewImage");

              fileInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // ✅ Accept only valid image formats
                if (!file.type.startsWith("image/")) {
                  Swal.close();
                  Swal.fire({
                    icon: 'warning',
                    title: 'Invalid Image File',
                    text: 'Please upload a valid image file (JPEG, PNG, GIF, WebP) and try again.',
                    showConfirmButton: true,
                    confirmButtonText: 'OK',
                    customClass: {
                      popup: 'swal-popup-professional',
                      title: 'swal-title-professional',
                      content: 'swal-text-professional',
                      confirmButton: 'swal-btn-professional'
                    }
                  });
                  return;
                }

                const reader = new FileReader();
                reader.onload = () => {
                  previewContainer.style.display = "block";
                  previewImage.src = reader.result;

                  // Destroy old cropper if exists
                  if (cropper) cropper.destroy();

                  cropper = new Cropper(previewImage, {
                    aspectRatio: 1,
                    viewMode: 2,
                    autoCropArea: 1,
                    responsive: true,
                  });
                };
                reader.readAsDataURL(file);
              });
            },
            willClose: () => {
              // ✅ Just destroy cropper, no overflow change
              if (cropper) cropper.destroy();
            },
            preConfirm: () => {
              if (!cropper) {
                Swal.showValidationMessage("Please select and crop an image!");
                return false;
              }

              return new Promise((resolve, reject) => {
                cropper.getCroppedCanvas().toBlob(async (blob) => {
                  try {
                    const formData = new FormData();
                    formData.append("profilePhoto", blob, "profile.jpg");

                    const res = await fetch("/upload-profile-photo", {
                      method: "POST",
                      body: formData,
                    });

                    const json = await res.json();
                    if (json.success) resolve(json);
                    else reject(json.message);
                  } catch (err) {
                    reject(err.message);
                  }
                }, "image/jpeg");
              });
            },
          }).then((result) => {
            if (result.isConfirmed) {
              if (result.value.success) {
                Swal.fire({
                  icon: "success",
                  title: "Profile Photo Updated!",
                  timer: 1500,
                  showConfirmButton: false,
                }).then(() => location.reload());
              } else {
                Swal.fire({
                  icon: "info",
                  title: "Profile photo updating failed!",
                  text: result.value.message + ', Try again!',
                  showConfirmButton: true,
                })
              }
            }
          });
        });

        async function editName(currentName, userId) {
          if (!userId) return Swal.fire("❌ Error", "User ID missing", "error");

          // Ask for new name
          const { value: newName } = await Swal.fire({
            title: "Edit Name",
            input: "text",
            inputLabel: "Enter your new full name",
            inputValue: currentName || "",
            inputPlaceholder: "Full name",
            confirmButtonText: "Update Name",
            showCancelButton: true,
            inputValidator: (value) => {
              if (!value.trim()) return "Name cannot be empty.";
              if (value.trim().length < 3) return "Name must be at least 3 characters.";
            },
          });

          if (!newName) return; // user cancelled

          console.log(newName);

          try {
            // Send request to backend to update name
            const response = await fetch("/update-name", {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name: newName.trim(), id: userId }),
            }).then((res) => res.json());

            if (response.success) {
              Swal.fire({
                icon: "success",
                title: "Name Updated!",
                text: response.message || "Your name has been successfully updated.",
                timer: 1500,
                showConfirmButton: false,
              }).then(() => location.reload());
            } else {
              Swal.fire("❌ Error", response.message || "Failed to update name.", "error");
            }
          } catch (err) {
            console.error("Error updating name:", err);
            Swal.fire("⚠️ Error", "Something went wrong. Please try again.", "error");
          }
        }

      </script>